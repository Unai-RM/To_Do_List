<div class="kanban-container">
  <div class="kanban-header">
    <h1>Tablero Kanban</h1>
    <div class="header-actions">
      <button class="btn-add-task" (click)="openModal()">
        + Nueva Tarea
      </button>
    </div>
  </div>

  <div class="kanban-board" cdkDropListGroup>
    <div 
      *ngFor="let column of columns; let i = index" 
      class="kanban-column"
      [attr.data-status]="column.status"
    >
      <div class="column-header">
        <h2>{{ column.name }}</h2>
        <span class="task-count">{{ column.tasks.length }}</span>
      </div>

      <div 
        class="task-list"
        cdkDropList
        [id]="'column-' + i"
        [cdkDropListData]="column.tasks"
        [cdkDropListConnectedTo]="getColumnIds()"
        (cdkDropListDropped)="drop($event, column)"
      >
        <div 
          *ngFor="let task of column.tasks" 
          class="task-card"
          cdkDrag
          (click)="openEditModal(task)"
        >
          <div class="task-header">
            <h3>{{ task.title }}</h3>
          </div>
          <p *ngIf="task.description" class="task-description">{{ task.description }}</p>
          <div class="task-footer">
            <span class="task-id">#{{ task.id }}</span>
          </div>
        </div>

        <div *ngIf="column.tasks.length === 0" class="empty-column">
          Sin tareas
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para crear tarea -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Nueva Tarea</h2>
      <button class="btn-close" (click)="closeModal()">×</button>
    </div>

    <div *ngIf="errorMessage" class="alert alert-error">
      {{ errorMessage }}
    </div>

    <form [formGroup]="taskForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="title">Título *</label>
        <input 
          type="text" 
          id="title" 
          formControlName="title" 
          class="form-control"
          [class.invalid]="title?.invalid && title?.touched"
          placeholder="Título de la tarea"
        >
        <div *ngIf="title?.invalid && title?.touched" class="error-message">
          <span *ngIf="title?.errors?.['required']">El título es requerido</span>
          <span *ngIf="title?.errors?.['minlength']">El título debe tener al menos 3 caracteres</span>
        </div>
      </div>

      <div class="form-group">
        <label for="description">Descripción</label>
        <textarea 
          id="description" 
          formControlName="description" 
          class="form-control"
          rows="4"
          placeholder="Descripción de la tarea (opcional)"
        ></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeModal()">
          Cancelar
        </button>
        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="taskForm.invalid || loading"
        >
          {{ loading ? 'Creando...' : 'Crear Tarea' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para editar tarea -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Editar Tarea</h2>
      <button class="btn-close" (click)="closeEditModal()">×</button>
    </div>

    <div *ngIf="errorMessage" class="alert alert-error">
      {{ errorMessage }}
    </div>

    <form [formGroup]="editForm" (ngSubmit)="onEditSubmit()">
      <div class="form-group">
        <label for="editTitle">Título *</label>
        <input 
          type="text" 
          id="editTitle" 
          formControlName="title" 
          class="form-control"
          [class.invalid]="editTitle?.invalid && editTitle?.touched"
          placeholder="Título de la tarea"
        >
        <div *ngIf="editTitle?.invalid && editTitle?.touched" class="error-message">
          <span *ngIf="editTitle?.errors?.['required']">El título es requerido</span>
          <span *ngIf="editTitle?.errors?.['minlength']">El título debe tener al menos 3 caracteres</span>
        </div>
      </div>

      <div class="form-group">
        <label for="editDescription">Descripción</label>
        <textarea 
          id="editDescription" 
          formControlName="description" 
          class="form-control"
          rows="4"
          placeholder="Descripción de la tarea (opcional)"
        ></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeEditModal()">
          Cancelar
        </button>
        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="editForm.invalid || loading"
        >
          {{ loading ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </form>
  </div>
</div>
